#!/bin/bash
cp ../../Config/Keys/id_rsa_nao /tmp/id_rsa_nao && id -g | sed 's/$/ \/tmp\/id_rsa_nao/' | xargs chgrp
( ( grep ssse3 </proc/cpuinfo ; echo 'ssse3=false') | head -1 | sed 's/.*ssse3 .*/ssse3=true/' ; (grep avx2 </proc/cpuinfo ; echo 'avx2=false') | head -1 | sed 's/.*avx2 .*/avx2=true/' ) | xargs ../../Util/SimRobot/Util/mare/Windows/bin/mare.exe --vcxproj=2017
for file in *.vcxproj; do
  sed <$file >/tmp/generate.tmp \
  -e "s%\&%AMPERSAND%g" \
  -e "s%<PropertyGroup Label=\"Globals\">%<PropertyGroup Condition=\"\$([MSBuild]::ValueOrDefault(\$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','ProductVersion')), \$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','ProductVersion')))) != ''\" Label=\"Globals\">\&    <WindowsTargetPlatformVersion>\$([System.IO.Path]::GetFileName('\$([System.IO.Directory]::GetDirectories('\$([MSBuild]::ValueOrDefault(\$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','InstallationFolder')), \$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','InstallationFolder'))))Include').GetValue(\$([System.IO.Directory]::GetDirectories('\$([MSBuild]::ValueOrDefault(\$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','InstallationFolder')), \$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','InstallationFolder'))))Include').GetUpperBound(0))))').Trim())</WindowsTargetPlatformVersion>\&  </PropertyGroup>\&  <PropertyGroup Condition=\"\$([MSBuild]::ValueOrDefault(\$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','ProductVersion')), \$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v10.0','ProductVersion')))) == '' and \$([MSBuild]::ValueOrDefault(\$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v8.1','ProductVersion')), \$([MSBuild]::GetRegistryValue('HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Microsoft SDKs\\\\Windows\\\\v8.1','ProductVersion')))) != ''\" Label=\"Globals\">\&    <WindowsTargetPlatformVersion>8.1</WindowsTargetPlatformVersion>\&  </PropertyGroup>\&  <PropertyGroup Label=\"Globals\">%" \
  && tr </tmp/generate.tmp '&' '\n' \
  | sed "s%AMPERSAND%\&%g" >$file
done
